---
  name: validate delta changes in PR
  on:
    pull_request:
      branches:
        - QA
  jobs:
    SFDX-CLI-Deploy:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/setup-node@v4
          with:
            node-version: "20"
        - run: echo "🐧 GitHub Action running on ${{ runner.os }}"
        - run: echo "🔎 Retrieving QA Branch from ${{ github.repository }}."
        - uses: actions/checkout@v4
          with:
            ref: QA
        
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Install Salesforce CLI
          run: |
            npm install @salesforce/cli --global
            sf --help
            pip install xq
            pip install yq
        - name: Debug Test Classes File
          run: cat test-classes.txt

        - name: Read Test Class Names from File
          id: read-test-classes
          run: |
            TEST_CLASSES=$(cat test-classes.txt | tr '\n' ',' | sed 's/,$//')
            if [ -z "$TEST_CLASSES" ]; then
              echo "TEST_CLASSES=" >> $GITHUB_ENV
              echo "RUN_TESTS=false" >> $GITHUB_ENV
            else
              echo "TEST_CLASSES=$TEST_CLASSES" >> $GITHUB_ENV
              echo "RUN_TESTS=true" >> $GITHUB_ENV
            fi
        
        - name: Install sfdxGit delta
          run: >
            echo y | sf plugins install sfdx-git-delta
  
            sf sgd:source:delta --to "HEAD" --from "HEAD~1"  --output "." --ignore .github/workflows/ignore.txt
  
            cat package/package.xml
        - name: Authenticate to Salesforce
          run: |
            echo ${{ secrets.SF_AUTH_URL }} > sfdx-auth-url.txt
            sfdx auth:sfdxurl:store --sfdx-url-file sfdx-auth-url.txt
        - name: validate Delta components to Salesforce RunSpecifiedTests
          if: ${{ env.APEX_TESTS != 'all' }}
          run: >
            sf project deploy validate --manifest package/package.xml --test-level
            RunSpecifiedTests --tests ${{ env.APEX_TESTS }} --target-org
            jp@sunsolutions.com
        - name: validate Delta components to Salesforce RunLocalTests
          if: ${{ env.APEX_TESTS == 'all' }}
          run: >
            sf project deploy validate --manifest package/package.xml --test-level
            RunLocalTests --target-org jp@sunsolutions.com
  